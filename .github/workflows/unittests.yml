name: Python Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black mypy

    - name: Check code formatting with black
      run: |
        black --check src/ tests/ dashboard/

    - name: Lint with flake8
      run: |
        flake8 src/ tests/ dashboard/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ dashboard/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Type check with mypy
      run: |
        mypy --ignore-missing-imports src/

    - name: Test data directory structure
      run: |
        if [ ! -d "data/raw" ]; then
          echo "‚ùå data/raw directory does not exist"
          exit 1
        fi
        if [ ! -d "data/processed" ]; then
          echo "‚ùå data/processed directory does not exist"
          exit 1
        fi
        echo "‚úÖ Data directories exist"

    - name: Check for required files
      run: |
        if [ ! -f "data/raw/ethiopia_fi_unified_data.csv" ]; then
          echo "‚ö†Ô∏è Creating sample data file for testing..."
          mkdir -p data/raw
          echo "record_type,pillar,indicator,indicator_code,value_numeric,observation_date,source_name,confidence" > data/raw/ethiopia_fi_unified_data.csv
          echo "observation,access,Account Ownership Rate,ACC_OWNERSHIP,49.0,2024-01-01,Global Findex,high" >> data/raw/ethiopia_fi_unified_data.csv
        fi

        if [ ! -f "data/raw/reference_codes.csv" ]; then
          echo "‚ö†Ô∏è Creating sample reference codes for testing..."
          echo "field,code,description" > data/raw/reference_codes.csv
          echo "record_type,observation,Measured value" >> data/raw/reference_codes.csv
          echo "record_type,event,Historical event" >> data/raw/reference_codes.csv
        fi

        if [ ! -f "requirements.txt" ]; then
          echo "‚ùå requirements.txt does not exist"
          exit 1
        fi

        if [ ! -f "dashboard/app.py" ]; then
          echo "‚ùå dashboard/app.py does not exist"
          exit 1
        fi
        echo "‚úÖ All required files exist"

    - name: Run unit tests with pytest
      run: |
        python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=html

    - name: Test data loader module
      run: |
        python -c "
        import sys
        sys.path.append('src')
        try:
            from data_loader import DataLoader
            loader = DataLoader()
            data, ref_codes = loader.load_data()
            print('‚úÖ DataLoader module loaded successfully')
            print(f'   Data shape: {data.shape if hasattr(data, \"shape\") else \"No shape\"}')
            print(f'   Reference codes shape: {ref_codes.shape if hasattr(ref_codes, \"shape\") else \"No shape\"}')
        except Exception as e:
            print(f'‚ùå DataLoader module failed: {e}')
            sys.exit(1)
        "

    - name: Test dashboard initialization
      run: |
        python -c "
        import sys
        sys.path.append('src')
        sys.path.append('dashboard')
        try:
            import app
            print('‚úÖ Dashboard modules can be imported')
            if hasattr(app, 'FinancialInclusionDashboard'):
                print('‚úÖ FinancialInclusionDashboard class exists')
            else:
                print('‚ö†Ô∏è FinancialInclusionDashboard class not found')
        except Exception as e:
            print(f'‚ùå Dashboard initialization failed: {e}')
            sys.exit(1)
        "

    - name: Create test data samples
      run: |
        mkdir -p data/processed
        mkdir -p models
        python -c "
        import pandas as pd
        from datetime import datetime
        enriched_data = pd.DataFrame({
            'record_type': ['observation', 'observation', 'event', 'impact_link'],
            'pillar': ['access', 'usage', None, 'access'],
            'indicator': ['Account Ownership', 'Digital Payments', 'Telebirr Launch', None],
            'indicator_code': ['ACC_OWNERSHIP', 'USG_DIGITAL_PAYMENT', None, 'ACC_OWNERSHIP'],
            'value_numeric': [49.0, 35.0, None, 15.0],
            'observation_date': ['2024-01-01', '2024-01-01', None, None],
            'event_date': [None, None, '2021-05-01', None],
            'source_name': ['Global Findex', 'Global Findex', 'Ethio Telecom', 'Model'],
            'confidence': ['high', 'high', 'high', 'medium']
        })
        enriched_data.to_csv('data/processed/enriched_data.csv', index=False)
        forecast_results = pd.DataFrame({
            'indicator': ['Account Ownership', 'Digital Payments'],
            'year': [2027, 2027],
            'scenario': ['base', 'base'],
            'forecast_value': [55.0, 45.0],
            'unit': ['%', '%']
        })
        forecast_results.to_csv('models/forecast_results.csv', index=False)
        "

    - name: Test forecasting module
      run: |
        python -c "
        import sys
        sys.path.append('src')
        try:
            from forecast_model import FinancialInclusionForecaster
            forecaster = FinancialInclusionForecaster('data/processed/enriched_data.csv')
            try:
                data = forecaster.prepare_forecast_data('ACC_OWNERSHIP')
                print(f'‚úÖ Forecast data preparation successful')
            except Exception as e:
                print(f'‚ö†Ô∏è Forecast data preparation warning: {e}')
            print('‚úÖ Forecasting module loaded successfully')
        except Exception as e:
            print(f'‚ùå Forecasting module failed: {e}')
            sys.exit(1)
        "

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          htmlcov/
          test-results.xml
        retention-days: 7

    - name: Archive coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports-python-${{ matrix.python-version }}
        path: |
          coverage.xml
        retention-days: 30

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install streamlit pytest

    - name: Run integration tests
      run: |
        python -c "
        import sys
        sys.path.append('src')
        try:
            from data_loader import DataLoader
            loader = DataLoader()
            raw_data, ref_codes = loader.load_data()
            print('‚úÖ Step 1: Data loading successful')
            from data_enricher import DataEnricher
            enricher = DataEnricher(raw_data)
            enricher.add_mobile_money_data()
            enriched_data = enricher.get_enriched_data()
            print(f'‚úÖ Step 2: Data enrichment successful')
            from eda_analyzer import EDAAnalyzer
            enriched_data.to_csv('temp_enriched.csv', index=False)
            analyzer = EDAAnalyzer('temp_enriched.csv')
            insights = analyzer.generate_key_insights()
            print(f'‚úÖ Step 3: EDA analysis successful')
            from forecast_model import FinancialInclusionForecaster
            forecaster = FinancialInclusionForecaster('temp_enriched.csv')
            forecasts = forecaster.forecast_all_indicators()
            print(f'‚úÖ Step 4: Forecasting successful')
            import os
            if os.path.exists('temp_enriched.csv'):
                os.remove('temp_enriched.csv')
            print('üéâ All integration tests passed!')
        except Exception as e:
            print(f'‚ùå Integration test failed: {e}')
            sys.exit(1)
        "

    - name: Test dashboard startup
      run: |
        timeout 30s python -c "
        import sys
        import streamlit as st
        class MockStreamlit:
            def __init__(self): self.calls = []
            def __getattr__(self, name):
                def method(*args, **kwargs): return self
                return method
        sys.modules['streamlit'] = MockStreamlit()
        sys.path.append('src')
        sys.path.append('dashboard')
        from app import FinancialInclusionDashboard
        dashboard = FinancialInclusionDashboard()
        print('‚úÖ Dashboard class instantiated successfully')
        "
      timeout-minutes: 2

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Run safety check
      run: |
        pip install safety
        safety check -r requirements.txt --full-report

    - name: Detect secrets
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  documentation-check:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: Check documentation completeness
      run: |
        [ -f "README.md" ] || { echo "‚ùå README.md missing"; exit 1; }
        [ -f "dashboard/README.md" ] || { echo "‚ùå dashboard/README.md missing"; exit 1; }
        echo "‚úÖ Documentation check complete"

  performance-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: pip install -r requirements.txt memory_profiler psutil
    - name: Run performance tests
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        dates = pd.date_range(start='2011-01-01', end='2024-12-31', freq='M')
        n_records = len(dates) * 10
        test_data = pd.DataFrame({'value_numeric': np.random.uniform(0, 100, n_records)})
        test_data.to_csv('data/processed/performance_test.csv', index=False)
        "
        python -m memory_profiler python -c "import pandas as pd; pd.read_csv('data/processed/performance_test.csv')"

  deploy-check:
    runs-on: ubuntu-latest
    needs: [test, integration-test, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Deployment readiness check
      run: |
        required_files=("requirements.txt" "dashboard/app.py" "src/__init__.py")
        for file in "${required_files[@]}"; do
          [ -f "$file" ] || { echo "‚ùå Missing: $file"; exit 1; }
        done
        python -m py_compile dashboard/app.py src/*.py
        echo "‚úÖ Ready for deployment"
